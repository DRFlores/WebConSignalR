@model WebConSignalR.Comentario

@{
    ViewBag.Title = "Web con SignalR";
}
<div class="container bg-info">
    <div class="text-center">
        <h1>Real Time Communication: SignalR</h1>
        <p class="lead">Dejanos tu comentario sobre SignalR!</p>
    </div>


    <img src="@Url.Content("~/Images/ilustracion.jpg")" width="200" height="200" alt="imagen ilustrativa" class="center-block" />
    <div class="row" id="comentarios">
        @if (ViewBag.Comentarios != null)
        {
            foreach (var item in @ViewBag.Comentarios)
            {

                <div class="media well well-sm col-md-8 col-md-offset-2">
                    <div class="media-left">
                        <a href="#">
                            <img class="media-object" src="@Url.Content("~/Images/perfil.jpg")" 
                                 width="64" height="64" alt="">
                        </a>
                    </div>
                    <div class="media-body">
                        <h4 class="media-heading">@item.usuario</h4>
                        @item.texto
                    </div>
                </div>
            }
        }
    </div>
    <div class="row">
         <form action="/Home/Index" method="post" class="text-center col-lg-12">

                <div class="form-group">
                    @Html.LabelFor(d => d.usuario, "Nombre:")
                    @Html.TextBoxFor(d => d.usuario, "", new { @class = "form-control center-block" })
                    @Html.ValidationMessageFor(d => d.usuario, "", new { @class = "text-danger" })
                </div>

                <div class="form-group">
                    @Html.LabelFor(d => d.texto, "Escribe tu comentario:")
                    @Html.TextAreaFor(d => d.texto, new { @class = "form-control center-block"})
                    @Html.ValidationMessageFor(d => d.texto, "", new { @class = "text-danger" })
                </div>

                <button type="submit" class="btn btn-default" id="comentar">Comentar</button>
            </form>

</div>
</div>

@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>

 <!--SignalR script para enviar el comentario y actualizar la página.-->
<script>
    $(function () {
     // Conectamos el Hub que creamos para los comentarios
        var comentario = $.connection.comentariosHub;
     // Creamos una función que el Hub puede llamar para mostrar los 
     // comentarios en todos los clientes conectados
        comentario.client.addNewMessageToPage = function (usuario, texto) {
     // Agregamos el comentario recibido al div contenedor con id="comentarios"
     // con los datos recibidos por parametro desde el servidor
            $('#comentarios').append('<div class="media well well-sm col-md-8 col-md-offset-2">'
            +'<div class="media-left"> <a href="#">'+
                '<img class="media-object" src="@Url.Content("~/Images/perfil.jpg")"'
                +'width = "64" height = "64" alt = "" > '
                + '</a> </div> <div class="media-body"> <h4 class="media-heading">' + usuario +
                '</h4>' + texto + '</div> </div>');
        };
    // Iniciamos la conexion en los clientes para que puedan recibir mensajes desde el servidor
        $.connection.hub.start();

    });
        
</script>
}

